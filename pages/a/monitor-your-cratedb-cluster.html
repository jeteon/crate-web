title: Monitoring a scalable SQL DB
link: https://crate.io/blog/monitoring-a-scalable-sql-db
author: Claus Matzinger
description: What metrics to look for in a scalable SQL DB.
created: 2016-11-09
post_name: monitoring-a-scalable-sql-db
status: publish
post_type: post
tags: developernews, features
category: post



CrateDB is running in production in companies around the world, with users applying a range of different monitoring solutions to ensure cluster health and responsiveness. We hope that this blogpost can help provide an overview on how and what we reccomend monitoring when running CrateDB. Effective monitering should allow our users to identify potential hardware/software issues or to see if changes to cluster size would benefit performance.

## Importance of Metrics

Metrics for your database should provide a high level overview on what is going on in the database. To understand what metrics should be monitored in your CrateDB, some in-depth knowledge about CrateDB's internal workings is required. There are two important scenarios that require CrateDB specific knowledge: Insert/update/delete and queries.

### Inserts, Updates, Deletes

Fundamentally, CrateDB uses [Lucene][1] indices underneath. Simplified, an index is a file on disk that stores an [inverted index](https://en.wikipedia.org/wiki/Inverted_index) as an immutable array to binary search on. Consequently there are no real updates or deletes - only inserts and merges. Inserts add new segments which are eventually merged (can be executed manually by running [OPTIMIZE TABLE](/docs/reference/sql/reference/optimize.html) or will be triggered as needed by Lucene), where documents that are marked for deletion are skipped and the old segments are deleted through this process. Practically, this means that update processes are managed through inserts, with documents to be deleted being left out of the update process. These processes are the primary cause of disk I/O. Additionally, deleting or updating with a condition attached will use memory and may result in into heap memory issues.

### Queries

CrateDB holds every row as a document in a shard - effectively its own [Lucene][1] index which is then searched for the desired value(s). While this operation consumes some CPU - the amount used depends on the complexity of the filter. In computing large (intermediate) results, available heap space is often a more important factor. The actual amount of heap space required is determined by the nature of the query itself, since for aggregations the homogeneity of a field's values is important, whereas for projection queries the sizes of the selected fields matters most. Additionally 'handler nodes' ultimately apply Limit and Offset (and sometimes merge results), causing the node to require more memory than other participants.

## Define Metrics and Limits

The most important part of monitoring a CrateDB cluster is the understanding of which metrics you care about and why. At Crate.io we are trying to keep things simple and we have included some fundamental metrics in the AdminUI.

![CrateDB monitors CPU, heap, and disk](/static/images/1116/crate-db-load.png)

The numbers provided indicate a general load on the machine as well as within CrateDB:
- CPU (overall and CrateDB) usage
- Heap usage
- Disk usage
- Disk I/O

For use with CrateDB we recommend monitoring at least the numbers listed above in order to better understand the health of cluster. It can make sense for large clusters to monitor a node's network connection to see if the infrastructure is causing a bottleneck or to identify nodes with an unusual amount of client connections. For basic monitoring purposes, standard Linux tools are a great way to get the number of active connections: `netstat -an | grep :4200 | wc -l` provides the number of active TCP connections on port 4200, ([CrateDB's HTTP port](https://crate.io/docs/reference/configuration.html#ports)).



You may also want to monitor business-linked metrics for performance of tools or services connected to your Crate database.
While these metrics likely to be tied to CPU or disk I/O, effective monitoring is important to be able to deliver predictable quality to your customers. Examples of useful metrics include the 95th percentile of query times, queries per second, inserts per second, etc. but in order to get reproducible results the set of queries has to be predefined. One common method is to look into CrateDB's actual response times is to activate the [sys.jobs table](/docs/reference/sql/system.html#logs) and periodically check query times recorded there.

### CPU

CPU is tracked using the OS' load metric, which is determined by how many CPU tasks (either threads or processes) are queued at a certain time. CrateDB dedicates considerable time to working on CPU-intensive tasks, which is why this number is probably the most important indicator for high load. To recognize a long-term high load on the cluster, look at the 15-minute load average: A sustainable cluster should [have a load lower than 0.7 per core per CPU](http://blog.scoutapp.com/articles/2009/07/31/understanding-load-averages).

### Memory (heap)

Memory management can be tricky in Java applications since there is runtime garbage collection which is occasionally hard to predict. However, any query (or insert/update/delete) requires enough memory to run, otherwise our [CircuitBreaker](/docs/reference/configuration.html#query-circuit-breaker) causes the query to fail in order to protect the user from OutOfMemory exceptions. The CircuitBreaker's limits can be adjusted but it's usually recommended to optimize the queries to test for their involvement in underlying problems, when encountered. In general the amount of memory provided should reflect the query load (also, see 'Queries' above) - concurrency and result sets as well as client connections should be taken into account!


### Disk (I/O)

The disk is CrateDB's data store and optimized indices aside, the disk will be utilized for each query and especially [COPY FROM](/docs/reference/sql/reference/copy_from.html) can saturate the disk's I/O capacities. Additionally, with growing data sizes and replication, monitoring disk space and I/O performance is critical to ensure that a cluster continues to serve reliably. Particularly the disk usage is something CrateDB can be picky about and for larger disks it's recommended to set the [watermarks](/docs/reference/configuration.html#disk-based-shard-allocation) accordingly.

## What Now?

Monitoring the cluster's CPU, memory, and disk is only the first step, with appropriate responses to this data being key. Of course the actions are highly dependent on what the business case for this particular CrateDB cluster is and what the goals are. However, in general there are a few common responses available and developers and administrators should have an idea of:

- **Mistakes:** Mistakes happen and sometimes the heap size is not set properly or an existing table setup exhibits unexpected behavior from testing. The first step should always be to find out if something changed (recently) and if everything [is set up properly](/docs).
- **Optimize:** This is the most important point. By choosing the number of shards right and having suitable partitions and routing set up, along with any customized [configuration](/docs/reference/configuration.html) and optimized queries will get the most out of a cluster.
- **Scale out:** CrateDB is horizontally scalable and adding machines can help since the same number of shards will be worked on by a larger number of nodes.
- **Ask:** We are happy to help ðŸ˜Š. We will respond on [StackOverflow](https://stackoverflow.com/tags/crate) or if you feel it's a bug open a ticket on [GitHub](https://github.com/crate/crate). For production issues, we recommend our [Enterprise Support plans](/enterprise/support) available!

To sum up, monitoring a CrateDB cluster can not only improve its performance but also improve code quality and queries - which in turn can end up saving money and time! Furthermore having an eye on the cluster can prevent unexpected outages and provides a glimpse on what is often the heart of a thriving business!

We are always curious about your use cases and how you monitor them, let us know on [twitter](https://twitter.com/crateio)!


[1]: https://lucene.apache.org/
